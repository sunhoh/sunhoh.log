---
title: '브라우저의 로딩 과정'
date: '2023.11.10'
category: webdocument
description: '웹은 어떻게 보여지는 것인가?'
tags: ['dom', 'crp']
thumbnail: 'thumbnail.png'
---

#### 들어가며
브라우저의 로딩 과정에서 알아야하는 개념인 dom

DOM이란?  문서 객체 모델 DOM은 웹페이지에 대한 프로그래밍 인터페이스이다.  
기본적으로 여러 프로그램들이 페이지의 콘텐츠 및 구조, 그리고 스타일을 읽고 조작할 수 있게 연결시켜주는 역활을 담당한다.

브라우저가 페이지에 대한 HTML 응답을 받으며 화면에 표시되기 전에 몇번의 단계를 거쳐야 하는데 그 빌드과정을 'Critical Rendering Path', CRP이라고 한다. CRP의 순서는 다음과 같다.


### 1. 파싱
브라우저에서 웹 페이지를 로드하면 가장 먼저 HTML 파일을 다운로드한다. 파싱은 다운로드한 HTML을 해석하여 DOM 트리를 구성하는 단계이다. 파싱 중  <script />, <link />, <img />를 발견하면 각 리소스를 요청하고 다운로드한다. HTML 또는 리소스에 CSS가 포함된 경우에는 CSSOM 트리 구성 작업도 함께 진행한다. DOM 트리 및 CSSOM 트리가 구성되는 방법은 다음과 같다.



#### DOM 트리 구성
다운로드한 HTML을 해석해 DOM을 생성한 후, 각 DOM 객체를 트리 데이터 구조로 연결해 부모-자식 관계를 갖도록 만든다.
파싱이 일어나면 HTML을 해석해 DOM을 생성한 후, 각 DOM 객체를 트리 데이터 구조로 연결해 부모-자식 관계를 갖도록 만든다.  
각 태그가 DOM 트리의 노드로 생성되고 자식 노드를 참조한다.
![](/images/posts/crp/dom-tree.png)

#### CSSOM 트리 구성
style.css처럼 외부 스타일시트 파일이나 내부 스타일시트가 포함되어 있을 경우, CSS를 해석해 CSSOM 트리를 구성한다.
![](/images/posts/crp/cssom-tree.png)




### 2. 스타일

파싱 단계에서 생성된 DOM, CSSOM 트리를 가지고 스타일을 매칭시켜주는 과정을 거쳐 렌더 트리를 구성한다. 아래 이미지 처럼 DOM 트리와 CSSOM 트리를 조합해 렌더 트리가 구성되는 과정을 보여준다.
![](/images/posts/crp/render-tree.avif)


### 3. 레이아웃
레이아웃 단계에서는 렌더 트리를 기반으로 각 요소의 크기와 위치를 계산하여 레이아웃을 구성한다.
노드의 정확한 크기와 위치를 파악하기 위해 루트부터 노드를 순회하면서 계산하고, 레이아웃 결과로 각 노드의 정확한 위치와 크기를 픽셀값으로 렌더트리에 반영한다. 
> 만약 CSS에서 크기 값을 %로 지정하였다면, 레이아웃 단계를 거친 후 % 값은 계산되고 측정 가능한 픽셀 단위로 변환된다.



### 4. 페인트

레이아웃 단계에서 렌더 트리의 각 노드를 화면상의 실제 픽셀로 변환한다.
포토샵의 레이어처럼 생성되어 개별 레이어로 관리된다. 따라서 다른 레이어에 다시 칠할 필요 없이 한 레이어만 변경하는 것이 가능하다. 이 과정을 페인트라고 한다.  
> 단, 각각의 엘리먼트가 모두 레이어가 되는 것은 아니다.

![](/images/posts/crp/paint.png)



### 5. 합성 & 렌더
페인트 단계에서 생성된 레이어를 합성하여 스크린을 업데이트한다. 합성과 렌더 단계가 끝나면 화면에서 웹 페이지를 볼 수 있다.

다양한 페인트 레이어를 가져와 컴포지터 전용 속성을 적용하고 이를 하나의 이미지로 변환한다. 이는 기본적으로 레이어를 쌓아서 사진을 찍는 것과 같다. 합성과 렌더 단계가 끝나면 화면에서 이 이미지가 화면에 렌더링된다.
![](/images/posts/crp/composite.png)

#### 리플로우, 리페인트
 브라우저 로딩 과정 중 스타일 이후의 과정(스타일 -> 레이아웃 -> 페인트 -> 합성)을 렌더링이라고 하는데, 
 이 렌더링 과정은 상황에 따라 반복하여 발생할 수 있다. 스타일 단계에서 구성되는 렌더 트리는 자바스크립트에 의해 DOM 트리, CSSOM 트리가 변경될 때 다시 재구성된다. DOM이 추가/삭제되거나 요소에 기하적인 영향(높이, 넓이, 위치)을 주는 CSS 속성값을 변경하는 경우, 렌더 트리가 다시 재구성된다. 즉, 레이아웃부터 이후 과정을 다시 수행하며 이것을 리플로우라고 한다(또는 레이아웃).

```js
// Reflow를 발생시키는 속성
position / width / height / margin / padding / display / top / left / right / bottom /  border / border-width / text-shadow ...
```

레이아웃은 요소에 기하적인 영향을 주는 CSS 속성값을 변경할 때 발생한다고 하였는데, 반대로 영향을 주지 않는 CSS 속성값을 변경하면 레이아웃 과정을 건너뛴다. 페인트부터 수행하며 이를 리페인트라고 한다.

```js
// Repaint를 발생시키는 속성
color / border-style / background / outline / box-shadow ...
```

----
#### reference
- [성능 최적화](https://ui.toast.com/fe-guide/ko_PERFORMANCE)
